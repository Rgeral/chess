# ---- Builder ----
FROM rust:1.80-slim as builder

WORKDIR /app

# Make DATABASE_URL available during build for sqlx macros (use absolute path form)
ENV DATABASE_URL=sqlite:///app/sqlx.db

# Installer Rust nightly
RUN rustup install nightly && rustup default nightly

# Installer sqlx-cli (sqlite uniquement, pas besoin de Postgres/MySQL)
RUN cargo install sqlx-cli --no-default-features --features sqlite

# Copier seulement Cargo.toml pour build des deps en cache
COPY Cargo.toml ./
RUN mkdir src && echo "fn main() {}" > src/main.rs
RUN cargo +nightly build --release || true

# Copier tout le code
COPY . .

# Prepare a temporary SQLite DB and run migrations so sqlx::query! can validate at compile time
RUN touch /app/sqlx.db && sqlx migrate run

# Compiler le binaire final
RUN cargo +nightly build --release

# ---- Runtime ----
FROM debian:bookworm-slim

# Installer dépendances runtime
RUN apt-get update && apt-get install -y \
    stockfish \
    sqlite3 \
    curl \
    ca-certificates \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copier sqlx-cli et le backend depuis builder
COPY --from=builder /usr/local/cargo/bin/sqlx /usr/local/bin/sqlx
COPY --from=builder /app/target/release/chess-backend /app/chess-backend

# Copier les migrations
COPY ./migrations ./migrations

# Créer dossier data (pour SQLite)
RUN mkdir -p /app/data && chmod 777 /app/data

EXPOSE 8080

# Lancer le backend
CMD ["./chess-backend"]
